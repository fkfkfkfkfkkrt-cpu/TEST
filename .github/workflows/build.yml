name: Lotto AI App CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions: write-all

jobs:
  build_ios:
    name: Build iOS IPA
    runs-on: macos-latest
    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Get Flutter Dependencies
        run: flutter pub get
        
      - name: Set Environment Variables
        if: github.event_name != 'pull_request'
        run: |
          echo "VERSION=1.1.$(date +%Y%m%d.%H%M)" >> "$GITHUB_ENV"
          echo "TAG=v1.1.$(date +%Y%m%d.%H%M)" >> "$GITHUB_ENV"
          echo "COMMIT_ID=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"
          echo "COMMIT_MSG<<EOF" >> "$GITHUB_ENV"
          git log -1 --pretty=%B >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
          echo "APP_NAME=æ¨‚é€æ™ºé¸-$(date +%Y%m%d-%H%M).ipa" >> "$GITHUB_ENV"
        
      - name: Build iOS (no codesign)
        run: |
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          mkdir Payload
          mv Runner.app Payload/
          zip -r æ¨‚é€æ™ºé¸-$(date +%Y%m%d-%H%M).ipa Payload/
          
      - name: Create Release
        if: github.event_name != 'pull_request'
        uses: ncipollo/release-action@v1.16.0
        with:
          tag: ${{ env.TAG }}
          name: æ¨‚é€æ™ºé¸ v${{ env.VERSION }} - ${{ env.COMMIT_ID }}
          body: |
            ğŸ“± **æ¨‚é€æ™ºé¸ iOS App** | ç‰ˆæœ¬ `${{ env.VERSION }}` | Commit ${{ env.COMMIT_ID }}
            
            ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªå‹•æ§‹å»º
            
            ### ğŸ“‹ æ›´æ–°å…§å®¹
            ${{ env.COMMIT_MSG }}
            
            ### ğŸ“¥ ä¸‹è¼‰èªªæ˜
            ä¸‹è¼‰ `.ipa` æ–‡ä»¶å¾Œï¼Œå¯ä½¿ç”¨ AltStoreã€Sideloadly æˆ–å…¶ä»–å·¥å…·å®‰è£åˆ° iOS è¨­å‚™
          artifacts: |
            build/ios/iphoneos/*.ipa
          generateReleaseNotes: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
